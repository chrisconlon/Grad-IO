% Provides guarded package loads and common macros for Teaching slides
\ProvidesPackage{teaching_slides}[2025/10/03 Conlon Teaching Preamble]

% read class options
% \ifdefined\beamerclassoptions
%     % Expand \beamerclassoptions (which should be like "[notes=show]") safely
%     \begingroup\edef\x{\endgroup\noexpand\documentclass\beamerclassoptions{beamer}}\x
% \else
%     \documentclass[handout,10pt,aspectratio=169]{beamer}
% \fi


% silence some Metropolis warnings (silence package may not be available at this stage)
\RequirePackage{silence}
\WarningFilter{beamerthememetropolis}{You need to compile with XeLaTeX or LuaLaTeX}
\WarningFilter{latexfont}{Font shape}
\WarningFilter{latexfont}{Some font}

% define custom colors
\RequirePackage{xcolor}
\definecolor{darkgray}{HTML}{444444}
\definecolor{lightgray}{HTML}{777777}
\definecolor{darkred}{HTML}{BB0000}
\definecolor{darkgreen}{HTML}{00BB00}
\definecolor{RoyalBlue}{cmyk}{1, 0.50, 0, 0}

\definecolor{dimwhite}{rgb}{0.99, 0.99, 0.99}
\definecolor{charcoal}{rgb}{0.21, 0.27, 0.31}
\definecolor{slategray}{rgb}{0.44, 0.5, 0.56}
\definecolor{dimgray}{rgb}{0.41, 0.41, 0.41}
\definecolor{bleudefrance}{rgb}{0.19, 0.55, 0.91}

% configure metropolis (the theme package itself is loaded by the document)
\usetheme[progressbar=frametitle, numbering=fraction,block=fill]{metropolis}
\setbeamercolor{author}{fg=charcoal}
\setbeamercolor{background canvas}{bg=white}
\setbeamercolor{section in toc}{fg=charcoal}
\setbeamercolor{subsection in toc}{fg=dimgray}
\setbeamercolor{frametitle}{bg=dimwhite, fg=charcoal}
\setbeamercolor{progress bar}{fg=slategray, bg=fg!50!black!30}
\setbeamersize{text margin left=7mm,text margin right=7mm} 
\setbeamercovered{transparent=10}

% use thicker lines
\makeatletter
\setlength{\metropolis@titleseparator@linewidth}{1pt}
\setlength{\metropolis@progressonsectionpage@linewidth}{1pt}
\makeatother

% custom bullet points (safe to include multiple times)
\setbeamertemplate{itemize items}{\scriptsize$\blacktriangleright$}
\setbeamertemplate{itemize subitem}[circle]
\setbeamertemplate{itemize subsubitem}[square]


% imports
\RequirePackage[english]{babel}
\RequirePackage{amsthm}
\RequirePackage{amssymb}
\RequirePackage{amsmath}
\RequirePackage{amsfonts}
\RequirePackage{mathtools}
% \RequirePackage{mathabx}  % Comment out mathabx as it conflicts with mathcal
\RequirePackage{mathrsfs}  % Provides \mathscr for script fonts
\RequirePackage{stmaryrd}
\RequirePackage{graphicx}
\RequirePackage{hyperref}
\RequirePackage{xfrac}
\RequirePackage{appendixnumberbeamer}
\RequirePackage{tabularx}

% Redefine \mathcal to use script fonts
\let\mathcal\mathscr

% Special definitions for common calligraphic letters that work with unicode-math
\AtBeginDocument{%
  % Simple approach: directly define the problematic letters
  \providecommand{\calS}{\ensuremath{\mathscr{S}}}
  \providecommand{\calD}{\ensuremath{\mathscr{D}}}
  \providecommand{\calJ}{\ensuremath{\mathscr{J}}}
  \providecommand{\calF}{\ensuremath{\mathscr{F}}}
  \providecommand{\calH}{\ensuremath{\mathscr{H}}}
}


% Make common graphics paths available so \includegraphics finds images from
% standard resources locations regardless of nesting depth.
\graphicspath{{./}{./resources/}{../resources/}{../../resources/}}

% Hyperref link coloring (safe defaults); files can override further if needed.
\hypersetup{
    colorlinks=true,
    linkcolor=RoyalBlue,
    citecolor=darkgreen,
    urlcolor=RoyalBlue
}

% check and x marks
\RequirePackage{pifont}
\providecommand{\cmark}{{\color{darkgreen}\ding{51}}\hspace{0.3em}}
\providecommand{\xmark}{{\color{darkred}\ding{55}}\hspace{0.5em}}


% use classic font for math (try to load concmath if available)
\RequirePackage[T1]{fontenc}
\usefonttheme{serif}
\usefonttheme{professionalfonts}
% micro-typography (safe when available)
\IfFileExists{microtype.sty}{\RequirePackage{microtype}}{}

% If compiling with XeLaTeX or LuaLaTeX enable fontspec and optional unicode-math
% Guard font selections so slides won't fail on machines missing a specific font.
\IfFileExists{fontspec.sty}{%
    \RequirePackage{fontspec}
    \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}

    % Main/sans/mono font selection with fallbacks. Prefer Fira families if present,
    % then TeX Gyre, then a common system fallback. Use \IfFontExistsTF provided by fontspec.
    \IfFontExistsTF{Fira Sans}{%
        \setmainfont{Fira Sans}%
        \setsansfont{Fira Sans}%
    }{%
        % If Fira isn't installed, prefer TeX Gyre if the file is available, otherwise use Latin Modern / system sans.
        \IfFileExists{TeXGyreTermes-Regular.otf}{%
            \setmainfont{TeX Gyre Termes}%
            \setsansfont{TeX Gyre Heros}%
        }{%
            \setmainfont{Latin Modern Roman}%
            \setsansfont{TeX Gyre Heros}%
        }
    }

    % Monospaced: prefer Fira Mono (or Fira Code), then TeX Gyre Cursor, then Courier New.
    \IfFontExistsTF{Fira Mono}{%
        \setmonofont{Fira Mono}%
    }{%
        \IfFontExistsTF{Fira Code}{%
            \setmonofont{Fira Code}%
        }{%
            \IfFileExists{TeXGyreCursor-Regular.otf}{%
                \setmonofont{TeX Gyre Cursor}%
            }{%
                \setmonofont{Courier New}%
            }
        }
    }

    % Optional better unicode math support when present (Xe/Lua only)
    \IfFileExists{unicode-math.sty}{\RequirePackage{unicode-math}}{}
}{}

% make equation font readable across themes (less tiny)
\setbeamerfont{equation}{size=\small}


% diagrams
\RequirePackage{tikz}
\usetikzlibrary{decorations.pathreplacing}

% references
\RequirePackage[natbibapa]{apacite}
\bibliographystyle{apacite}
\renewcommand{\bibsection}{}

% use ampersands instead of "and" for text citations
\AtBeginDocument{\renewcommand{\BBAB}{\&}}

% possessive cites
\makeatletter
\patchcmd{\NAT@test}{\else \NAT@nm}{\else \NAT@nmfmt{\NAT@nm}}{}{}
\DeclareRobustCommand\citepos
  {\begingroup
   \let\NAT@nmfmt\NAT@posfmt
   \NAT@swafalse\let\NAT@ctype\z@\NAT@partrue
   \@ifstar{\NAT@fulltrue\NAT@citetp}{\NAT@fullfalse\NAT@citetp}}
\let\NAT@orig@nmfmt\NAT@nmfmt
\def\NAT@posfmt#1{\NAT@orig@nmfmt{#1's}}
\makeatother

% spaced-out lists (guarded)
\makeatletter
\@ifundefined{wideitemize}{\newenvironment{wideitemize}{\itemize\addtolength{\itemsep}{10pt}}{\enditemize}}{}
\@ifundefined{wideenumerate}{\newenvironment{wideenumerate}{\enumerate\addtolength{\itemsep}{10pt}}{\endenumerate}}{}
\makeatother

% replace footnotes with buttons (guarded)
\RequirePackage[absolute,overlay]{textpos}
\makeatletter
\@ifundefined{c@beamerpausessave}{\newcounter{beamerpausessave}}{}
\@ifundefined{always}{\newcommand{\always}[1]{%
    \setcounter{beamerpausessave}{\value{beamerpauses}}%
    \setcounter{beamerpauses}{0}%
    \pause%
    #1 %
    \setcounter{beamerpauses}{\value{beamerpausessave}}%
    \addtocounter{beamerpauses}{-1}%
    \pause%
}}{}
\@ifundefined{buttons}{\newcommand{\buttons}[1]{\always{%
    \begin{textblock*}{\paperwidth}(0.015\textwidth, 1.022\textheight)
        \scriptsize
        ##1
    \end{textblock*}
}}}{}
\@ifundefined{appendixbuttons}{\newcommand{\appendixbuttons}[1]{\always{%
    \begin{textblock*}{\paperwidth}(0.015\textwidth, 1.043\textheight)
        \scriptsize
        ##1
    \end{textblock*}
}}}{}
\@ifundefined{goto}{\newcommand{\goto}[2]{\hyperlink{#1}{{\color{dark red}$\smalltriangleright$} #2}\hspace{0.5em}}}{}
\@ifundefined{goback}{\newcommand{\goback}[2]{\hyperlink{#1}{{\color{dark red}$\smalltriangleleft$} #2}\hspace{0.5em}}}{}
\makeatother

% custom appendix
\renewcommand{\appendixname}{\texorpdfstring{\translate{Appendix}}{Appendix}}

% change color of cites and URLs (guarded; keep previous defs if present)
\makeatletter
\@ifundefined{oldcite}{\let\oldcite\cite}{}
\@ifundefined{oldcitet}{\let\oldcitet\citet}{}
\@ifundefined{oldcitep}{\let\oldcitep\citep}{}
\@ifundefined{oldcitepos}{\let\oldcitepos\citepos}{}
\@ifundefined{oldcitetalias}{\let\oldcitetalias\citetalias}{}
\@ifundefined{oldcitepalias}{\let\oldcitepalias\citepalias}{}
\@ifundefined{oldurl}{\let\oldurl\url}{}
\def\cite#1#{\citeaux{#1}}
\def\citet#1#{\citetaux{#1}}
\def\citep#1#{\citepaux{#1}}
\def\citepos#1#{\citeposaux{#1}}
\def\citetalias#1#{\citetaliasaux{#1}}
\def\citepalias#1#{\citepaliasaux{#1}}
\def\url#1#{\urlaux{#1}}
\@ifundefined{citeaux}{\newcommand*\citeaux[2]{{\color{lightgray}\oldcite#1{#2}}}}{}
\@ifundefined{citetaux}{\newcommand*\citetaux[2]{{\color{lightgray}\oldcitet#1{#2}}}}{}
\@ifundefined{citepaux}{\newcommand*\citepaux[2]{{\color{lightgray}\oldcitep#1{#2}}}}{}
\@ifundefined{urlaux}{\newcommand*\urlaux[2]{{\color{lightgray}\oldurl#1{#2}}}}{}
\@ifundefined{citeposaux}{\newcommand*\citeposaux[2]{{\color{lightgray}\oldcitepos#1{#2}}}}{}
\@ifundefined{citetaliasaux}{\newcommand*\citetaliasaux[2]{{\color{lightgray}\oldcitetalias#1{#2}}}}{}
\@ifundefined{citepaliasaux}{\newcommand*\citepaliasaux[2]{{\color{lightgray}\oldcitepalias#1{#2}}}}{}
\makeatother

% custom math commands (guard declarations)
\makeatletter
% canonical math operators (use thinspace in "arg\,max" for nicer spacing)
\@ifundefined{argmax}{\DeclareMathOperator*{\argmax}{arg\,max}}{}
\@ifundefined{argmin}{\DeclareMathOperator*{\argmin}{arg\,min}}{}
\@ifundefined{Pr}{\renewcommand{\Pr}{\symbb{P}}}{}
\providecommand{\E}{\symbb{E}}
\providecommand{\Var}{\symbb{V}}
\providecommand{\Cov}{\symbb{C}}
\providecommand{\overbar}[1]{\mkern 1.5mu\overline{\mkern-1.5mu#1\mkern-1.5mu}\mkern 1.5mu}
\makeatother
\providecommand{\abs}[1]{\lvert#1\rvert}
\providecommand{\norm}[1]{\lVert#1\rVert}


% tables
\RequirePackage{booktabs}
\RequirePackage{colortbl}
\RequirePackage{multirow}
\RequirePackage{makecell}
\arrayrulecolor{darkred}

% custom date
\RequirePackage{datetime}
% \@ is a special char; ensure we're in \makeatletter mode when using \@ifundefined
\makeatletter
\@ifundefined{monthyeardate}{\newdateformat{monthyeardate}{\monthname[\THEMONTH] \THEYEAR}}{}
\makeatother

% fix pauses with graphics
\RequirePackage{fixpauseincludegraphics}

% End of package
